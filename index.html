<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Quit Tracker</title>

    <!-- PWA Meta -->
    <meta name="theme-color" content="#0a0e1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --accent-color: #3b82f6;
            --grid-empty: #e5e7eb;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #0a0a0a;
                --text-color: #ffffff;
                --accent-color: #60a5fa;
                --grid-empty: #1f2937;
            }
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .grid-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            background-color: var(--grid-empty);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* Highlight for the first 7 days */
        .first-week-highlight {
            position: absolute;
            inset: -4px;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.5;
        }

        .first-week-label {
            position: absolute;
            top: -18px;
            left: 0;
            font-size: 10px;
            font-weight: bold;
            color: var(--accent-color);
            text-transform: uppercase;
            white-space: nowrap;
        }

        .grid-cell.level-0 { background-color: #10b981; } /* Green - Neutral/Success */
        .grid-cell.level-1 { background-color: #84cc16; } /* Lime Green */
        .grid-cell.level-2 { background-color: #eab308; } /* Yellow/Gold */
        .grid-cell.level-3 { background-color: #f97316; } /* Orange */
        .grid-cell.level-4 { background-color: #ef4444; } /* Red */
        .grid-cell.level-5 { background-color: #7f1d1d; } /* Dark Red */
        .grid-cell.level-6 { background-color: #1a0505; } /* Black-Burgundy */

        /* Positive levels (Strength) */
        .grid-cell.level-p1 { background-color: #60a5fa; } /* Blue 400 */
        .grid-cell.level-p2 { background-color: #3b82f6; } /* Blue 500 */
        .grid-cell.level-p3 { background-color: #2563eb; } /* Blue 600 */
        .grid-cell.level-p4 { background-color: #1d4ed8; } /* Blue 700 */
        .grid-cell.level-p5 { background-color: #1e40af; } /* Blue 800 */
        .grid-cell.level-p6 { background-color: #1e3a8a; } /* Blue 900 */

        .grid-cell.current-day {
            /*border: 2px solid var(--accent-color);*/
            animation: pulse-border 2s infinite;
            position: relative;
            overflow: hidden;
        }

        .grid-cell.current-day::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shimmer 2.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 50;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            animation: modal-exit 0.3s ease forwards;
        }

        .modal.open .modal-content {
            animation: modal-enter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes modal-enter {
            from { opacity: 0; transform: scale(0.9) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes modal-exit {
            from { opacity: 1; transform: scale(1) translateY(0); }
            to { opacity: 0; transform: scale(0.9) translateY(20px); }
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .grid-cell.newly-changed {
            animation: cell-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cell-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .bg-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 40%);
        }

        /* Timer Animation */
        .timer-digit {
            display: inline-block;
            min-width: 0.6em;
            position: relative;
        }

        #timer {
            font-weight: 500;
        }

        #startDateInput {
            -webkit-appearance: none;
        }

        .digit-inner {
            display: inline-block;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s;
        }

        .digit-changing {
            transform: translateY(-20%) scale(0.8);
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-6 safe-area-top safe-area-bottom">
    <div class="bg-mesh"></div>

    <!-- Header / Progress Grid -->
    <header class="mb-8" style="margin-top: 35px;">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Прогресс</h1>
            <button id="settingsBtn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">
                <i data-lucide="settings"></i>
            </button>
        </div>
        <div id="progressGrid" class="grid grid-cols-10 gap-2 mb-2 relative">
            <!-- 30 cells will be generated here -->
            <div id="firstWeekHighlight" class="absolute pointer-events-none" style="display: none;">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
        <p class="text-sm opacity-60 text-center" id="progressText">0 из 30 дней</p>
    </header>

    <!-- Main Timer -->
    <main class="flex-grow flex flex-col items-center justify-center text-center py-12">
        <div class="mb-4 opacity-40 uppercase tracking-[0.2em] text-[10px] font-bold">Новое время</div>
        <div id="timer" class="text-[3.5rem] font-bold tabular-nums flex gap-2 items-baseline leading-none">
            <div class="flex flex-col items-center">
                <span class="timer-segment text-[3rem]" id="days-seg">00</span>
                <span class="text-[10px] uppercase opacity-30 mt-1 font-medium tracking-widest">Дни</span>
            </div>
            <span class="opacity-20 self-start mt-[0.2em]">:</span>
            <div class="flex flex-col items-center">
                <span class="timer-segment text-[3rem]" id="hours-seg">00</span>
                <span class="text-[10px] uppercase opacity-30 mt-1 font-medium tracking-widest">Часы</span>
            </div>
            <span class="opacity-20 self-start mt-[0.2em]">:</span>
            <div class="flex flex-col items-center">
                <span class="timer-segment text-[3rem]" id="mins-seg">00</span>
                <span class="text-[10px] uppercase opacity-30 mt-1 font-medium tracking-widest">Мин</span>
            </div>
            <span class="opacity-20 self-start mt-[0.2em]">:</span>
            <div class="flex flex-col items-center">
                <span class="timer-segment text-[2rem] opacity-60" id="secs-seg">00</span>
                <span class="text-[10px] uppercase opacity-30 mt-1 font-medium tracking-widest">Сек</span>
            </div>
        </div>
    </main>

    <footer class="mt-8">
        <div class="flex flex-row justify-center items-center gap-4 w-full max-w-2xl mx-auto">
            <button onclick="showConfirm('Добавить событие слабости?', () => submitEvent('слабость'))" class="flex-1 flex items-center justify-between p-4 rounded-2xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 active:scale-95 transition-all duration-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-yellow-500/10 rounded-xl flex items-center justify-center">
                        <i data-lucide="shield-alert" class="text-yellow-500 w-5 h-5"></i>
                    </div>
                    <span class="text-xs sm:text-sm font-bold tracking-tight uppercase opacity-80">Слабость</span>
                </div>
                <i data-lucide="chevron-right" class="opacity-20 w-4 h-4 sm:w-5 sm:h-5"></i>
            </button>

            <button onclick="showConfirm('Добавить событие силы?', () => submitEvent('сила'))" class="flex-1 flex items-center justify-between p-4 rounded-2xl bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 active:scale-95 transition-all duration-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center">
                        <i data-lucide="shield-check" class="text-blue-500 w-5 h-5"></i>
                    </div>
                    <span class="text-xs sm:text-sm font-bold tracking-tight uppercase opacity-80">Сила</span>
                </div>
                <i data-lucide="chevron-right" class="opacity-20 w-4 h-4 sm:w-5 sm:h-5"></i>
            </button>
        </div>
    </footer>

    <div id="settingsModal" class="modal">
        <div class="bg-white dark:bg-gray-900 w-full max-w-sm mx-4 p-8 rounded-[2.5rem] shadow-2xl modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Настройки</h2>
                <button id="closeSettings" class="p-1"><i data-lucide="x"></i></button>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm opacity-60 mb-2">Дата начала</label>
                    <input type="datetime-local" id="startDateInput" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-800 border-none outline-none focus:ring-2 ring-blue-500">
                </div>

                <div class="pt-4 border-t border-gray-100 dark:border-gray-800" style="display: none">
                    <button id="fullReset" class="w-full py-3 rounded-xl text-red-500 font-medium hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" style="display: none">
                        Сбросить всё (очистить историю)
                    </button>
                </div>

                <div class="pt-4 border-t border-gray-100 dark:border-gray-800">
                    <button id="copyBtn" class="w-full py-3 mb-4 rounded-xl bg-gray-100 dark:bg-gray-800 font-medium active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        <span id="copyBtnText">Копировать</span>
                    </button>
                    <button id="resetBtn" class="w-full py-4 rounded-2xl bg-blue-500 text-white font-bold active:scale-95 transition-transform shadow-lg shadow-blue-500/20">
                        ПРОИГРЫШ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xs mx-4 p-8 rounded-[2.5rem] shadow-2xl text-center modal-content border border-gray-100 dark:border-gray-800 relative overflow-hidden">
            <!-- Decorative background element -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500/20 to-transparent"></div>
            
            <div class="w-20 h-20 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-6 transition-transform hover:scale-110 duration-500">
                <div class="w-14 h-14 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center">
                    <i data-lucide="help-circle" class="text-red-500 w-8 h-8"></i>
                </div>
            </div>
            
            <h2 class="text-2xl font-black mb-3 tracking-tight">Вы уверены?</h2>
            <p class="text-sm leading-relaxed opacity-50 mb-10 px-2" id="confirmText">Это действие зафиксирует слабость в истории. Его нельзя будет отменить.</p>
            
            <div class="flex flex-col gap-3">
                <button id="confirmYes" class="w-full py-4 rounded-2xl bg-gray-900 dark:bg-white dark:text-gray-900 text-white font-bold active:scale-95 transition-all shadow-xl shadow-black/10 hover:shadow-red-500/20">
                    Да, подтверждаю
                </button>
                <button id="confirmCancel" class="w-full py-4 rounded-2xl font-bold opacity-30 hover:opacity-100 transition-all hover:bg-gray-50 dark:hover:bg-gray-800">
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="bg-white dark:bg-gray-900 w-full max-w-sm mx-4 p-8 rounded-[2.5rem] shadow-2xl text-center modal-content">
            <h2 class="text-xl font-bold mb-6" id="eventModalTitle">Уровень интенсивности</h2>
            <div class="space-y-4">
                <button onclick="submitEvent('средняя')" class="w-full py-4 rounded-2xl bg-gray-100 dark:bg-gray-800 font-bold active:scale-95 transition-transform">Средняя</button>
                <button onclick="submitEvent('сильная')" class="w-full py-4 rounded-2xl bg-red-500 text-white font-bold active:scale-95 transition-transform">Сильная</button>
                <button onclick="closeModal('eventModal')" class="w-full py-2 opacity-40 text-sm">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let state = {
            startDate: localStorage.getItem('startDate') ? new Date(localStorage.getItem('startDate')) : new Date(),
            events: JSON.parse(localStorage.getItem('events') || '[]')
        };

        // Demo Data if empty
        if (state.events.length === 0 && !state.startDate) {
            state.startDate = new Date();
            state.events = [];
            saveState();
        }

        function saveState() {
            localStorage.setItem('startDate', state.startDate.toISOString());
            localStorage.setItem('events', JSON.stringify(state.events));
        }

        // Initialize Grid
        const grid = document.getElementById('progressGrid');
        for (let i = 0; i < 30; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            grid.appendChild(cell);
        }

        function positionHighlight() {
            const highlight = document.getElementById('firstWeekHighlight');
            const cells = document.querySelectorAll('.grid-cell');
            const grid = document.getElementById('progressGrid');
            
            const now = new Date();
            const diff = now - state.startDate;
            const currentDayIndex = Math.floor(diff / (1000 * 60 * 60 * 24));
            const totalDaysTracked = currentDayIndex + 1;

            let endCellIndex = -1;
            if (totalDaysTracked < 8) {
                endCellIndex = 6; // First 7 cells
            } else if (totalDaysTracked < 16) {
                endCellIndex = 14; // First 15 cells
            }

            if (endCellIndex !== -1 && cells.length > endCellIndex) {
                const firstCell = cells[0];
                const lastCell = cells[endCellIndex];
                
                const gridRect = grid.getBoundingClientRect();
                const firstRect = firstCell.getBoundingClientRect();
                const lastRect = lastCell.getBoundingClientRect();

                const offset = 4;
                highlight.style.left = (firstRect.left - gridRect.left - offset) + 'px';
                highlight.style.top = (firstRect.top - gridRect.top - offset) + 'px';
                
                const numRows = Math.ceil((endCellIndex + 1) / 10);
                const rowHeight = firstRect.height + 8;
                
                if (endCellIndex < 10) {
                    // Single row
                    highlight.style.width = (cells[endCellIndex].getBoundingClientRect().right - firstRect.left + (offset * 2)) + 'px';
                    highlight.style.height = (rowHeight) + 'px';
                    
                    const w = parseFloat(highlight.style.width);
                    const h = parseFloat(highlight.style.height);
                    const r = 8;

                    highlight.innerHTML = `
                        <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" fill="none" xmlns="http://www.w3.org/2000/svg" class="opacity-40">
                            <rect x="1" y="1" width="${w-2}" height="${h-2}" rx="${r}" stroke="#3b82f6" stroke-width="2"/>
                        </svg>
                    `;
                } else {
                    // Multiple rows (e.g., 15 cells)
                    const fullWidth = gridRect.width + (offset * 2);
                    const fullHeight = (numRows * rowHeight);
                    const lastCellRight = lastCell.getBoundingClientRect().right - gridRect.left + offset;
                    
                    highlight.style.width = fullWidth + 'px';
                    highlight.style.height = fullHeight + 'px';
                    
                    const w = fullWidth;
                    const h = fullHeight;
                    const r = 8; // rounded-lg approximate radius
                    const x = lastCellRight + 4; // Add extra 4px to prevent "pressing"
                    const y = rowHeight;

                    // Create SVG for perfect borders
                    highlight.innerHTML = `
                        <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" fill="none" xmlns="http://www.w3.org/2000/svg" class="opacity-40">
                            <path d="
                                M ${r+1},1 
                                L ${w-r-1},1 
                                Q ${w-1},1 ${w-1},${r+1} 
                                L ${w-1},${y-r-1} 
                                Q ${w-1},${y-1} ${w-r-1},${y-1} 
                                L ${x+r+1},${y-1} 
                                Q ${x+1},${y-1} ${x+1},${y+r+1} 
                                L ${x+1},${h-r-1} 
                                Q ${x+1},${h-1} ${x-r-1},${h-1} 
                                L ${r+1},${h-1} 
                                Q 1,${h-1} 1,${h-r-1} 
                                L 1,${r+1} 
                                Q 1,1 ${r+1},1 
                                Z" 
                                stroke="#3b82f6" stroke-width="2" stroke-linejoin="round"
                            />
                        </svg>
                    `;
                }
                
                highlight.style.display = 'block';
            } else {
                highlight.style.display = 'none';
            }
        }
        
        // Initial position and on resize
        window.addEventListener('load', positionHighlight);
        window.addEventListener('resize', positionHighlight);

        // UI Elements
        const progressText = document.getElementById('progressText');
        const settingsModal = document.getElementById('settingsModal');
        const confirmModal = document.getElementById('confirmModal');
        const eventModal = document.getElementById('eventModal');
        const startDateInput = document.getElementById('startDateInput');

        let pendingEventType = null;
        let confirmCallback = null;

        function updateUI() {
            const now = new Date();
            const diff = now - state.startDate;

            if (diff < 0) {
                updateTimerDisplay(0, 0, 0, 0);
                updateGrid(0);
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            updateTimerDisplay(days, hours, minutes, seconds);
            updateGrid(diff);
        }

        function updateTimerDisplay(d, h, m, s) {
            updateSegment('days-seg', String(d).padStart(2, '0'));
            updateSegment('hours-seg', String(h).padStart(2, '0'));
            updateSegment('mins-seg', String(m).padStart(2, '0'));
            updateSegment('secs-seg', String(s).padStart(2, '0'));
        }

        function updateSegment(id, value) {
            const seg = document.getElementById(id);
            if (seg.textContent !== value) {
                // Create digits if they don't exist or just update
                if (seg.children.length === 0) {
                    seg.innerHTML = value.split('').map(digit => `<span class="timer-digit"><span class="digit-inner">${digit}</span></span>`).join('');
                } else {
                    const digits = value.split('');
                    Array.from(seg.children).forEach((child, i) => {
                        const inner = child.querySelector('.digit-inner');
                        if (inner.textContent !== digits[i]) {
                            inner.classList.add('digit-changing');
                            setTimeout(() => {
                                inner.textContent = digits[i];
                                inner.classList.remove('digit-changing');
                            }, 150);
                        }
                    });
                }
            }
        }

        function updateGrid(diffMs) {
            const cells = document.querySelectorAll('.grid-cell');

            // Current day index (0-based). If diff is 0-24h, it's day 1 (index 0).
            const currentDayIndex = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const totalDaysTracked = currentDayIndex + 1;

            cells.forEach((cell, i) => {
                const isCurrent = i === currentDayIndex && i < 30;
                cell.className = 'grid-cell'; // Reset classes
                if (isCurrent) {
                    cell.classList.add('current-day');
                }
                
                if (i < totalDaysTracked && i < 30) {
                    // Calculate "badness" for this specific day
                    const dayStart = new Date(state.startDate.getTime() + i * 24 * 60 * 60 * 1000);
                    const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);

                    const dayEvents = state.events.filter(e => {
                        const eventTime = new Date(e.time);
                        return eventTime >= dayStart && eventTime < dayEnd;
                    });

                    let score = 0;
                    dayEvents.forEach(e => {
                        if (e.type === 'сила') {
                            score -= 1; // Strength reduces badness
                        } else {
                            score += 1; // Weakness (or anything else) increases badness
                        }
                    });

                    let levelClass = 'level-0';
                    if (score > 0) {
                        let level = Math.min(score, 6);
                        levelClass = `level-${level}`;
                    } else if (score < 0) {
                        let level = Math.min(Math.abs(score), 6);
                        levelClass = `level-p${level}`;
                    }

                    cell.classList.add(levelClass);
                    
                    // If it's current day and has events, level-X will override current-day's background
                    // So we might want to preserve shimmer/pulse-border
                    if (isCurrent) {
                        cell.classList.add('current-day');
                    }
                }
            });
            progressText.textContent = `${Math.min(totalDaysTracked, 30)} из 30 дней`;
            positionHighlight();
        }

        function openEventModal(type) {
            pendingEventType = type;
            document.getElementById('eventModalTitle').textContent = type.charAt(0).toUpperCase() + type.slice(1);
            eventModal.classList.add('open');
        }

        function submitEvent(type) {
            state.events.unshift({
                type: type,
                intensity: 'обычная',
                time: new Date().toISOString()
            });
            state.events = state.events.slice(0, 50);
            saveState();
            closeModal('eventModal');
            updateUI();
            
            // Add animation to the current day cell
            const now = new Date();
            const diff = now - state.startDate;
            const currentDayIndex = Math.floor(diff / (1000 * 60 * 60 * 24));
            const cells = document.querySelectorAll('.grid-cell');
            if (cells[currentDayIndex]) {
                cells[currentDayIndex].classList.add('newly-changed');
                setTimeout(() => cells[currentDayIndex].classList.remove('newly-changed'), 500);
            }
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('open');
            setTimeout(() => {
                if (!m.classList.contains('open')) {
                    // Actual hiding happens via display: none if we wanted, 
                    // but since we use display: none/flex in CSS class 'open', 
                    // we need to handle the timing if we want fade out.
                    // For now, simple removal of 'open' class handles it via opacity.
                }
            }, 300);
        }

        function renderEvents() {
            // Function removed as per requirement
        }

        // Events
        document.getElementById('resetBtn').onclick = () => {
            showConfirm('Вы уверены, что хотите сбросить прогресс?', () => {
                state.startDate = new Date();
                state.events = [];
                localStorage.clear();
                saveState();
                updateUI();
                settingsModal.classList.remove('open');
            });
        };

        document.getElementById('copyBtn').onclick = () => {
            const now = new Date();
            const diff = now - state.startDate;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            const getDayPhase = (date) => {
                const h = date.getHours();
                if (h >= 4 && h < 6) return 'раннее утро';
                if (h >= 6 && h < 11) return 'утро';
                if (h >= 11 && h < 12) return 'позднее утро';
                if (h >= 12 && h < 17) return 'день';
                if (h >= 17 && h < 19) return 'ближе к вечеру';
                if (h >= 19 && h < 23) return 'вечер';
                return 'ночь';
            };

            const formatDate = (date) => {
                const months = [
                    'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                    'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
                ];
                return `${date.getDate()} ${months[date.getMonth()]}`;
            };

            const dayPhase = getDayPhase(now);
            const formattedDate = formatDate(now);
            const durationStr = `${days} дн ${hours} ч ${minutes} мин`;
            
            const textToCopy = `${formattedDate}, ${dayPhase} | ${durationStr}`;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const btnText = document.getElementById('copyBtnText');
                const originalText = btnText.textContent;
                btnText.textContent = "Скопировано";
                setTimeout(() => {
                    btnText.textContent = originalText;
                }, 2000);
            });
        };

        function showConfirm(text, callback) {
            document.getElementById('confirmText').textContent = text;
            confirmCallback = callback;
            confirmModal.classList.add('open');
        }

        document.getElementById('confirmYes').onclick = () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.remove('open');
        };

        document.getElementById('confirmCancel').onclick = () => {
            confirmModal.classList.remove('open');
        };

        document.getElementById('settingsBtn').onclick = () => {
            startDateInput.value = new Date(state.startDate.getTime() - state.startDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            settingsModal.classList.add('open');
        };

        document.getElementById('closeSettings').onclick = () => {
            settingsModal.classList.remove('open');
        };

        startDateInput.onchange = (e) => {
            state.startDate = new Date(e.target.value);
            saveState();
            updateUI();
        };

        document.getElementById('fullReset').onclick = () => {
            showConfirm('Это удалит всю историю событий и сбросит таймер. Продолжить?', () => {
                localStorage.clear();
                state.startDate = new Date();
                state.events = [];
                saveState();
                updateUI();
                settingsModal.classList.remove('open');
            });
        };

        // Start
        lucide.createIcons();
        setInterval(updateUI, 1000);
        updateUI();

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            });
        }

    </script>
</body>
</html>
